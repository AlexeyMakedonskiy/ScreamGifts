<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Stars Roulette</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stars-balance {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #ffd700;
            border-radius: 50px;
            padding: 10px 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .roulette-container {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .roulette-wheel {
            height: 200px;
            position: relative;
            overflow: hidden;
            border-radius: 10px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .roulette-items {
            display: flex;
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            transition: transform 3s cubic-bezier(0.2, 0.8, 0.3, 1);
        }

        .roulette-item {
            width: 150px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }

        .roulette-item.active {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid #ffd700;
        }

        .gift-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .gift-value {
            font-size: 16px;
            font-weight: bold;
            color: #ffd700;
        }

        .spin-button {
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            border: none;
            border-radius: 50px;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            color: #1a1a2e;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .spin-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
        }

        .spin-button:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .cost-info {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #aaa;
        }

        .inventory-section {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .inventory-section h2 {
            margin-bottom: 15px;
            text-align: center;
            color: #ffd700;
        }

        .inventory-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .inventory-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .withdraw-button {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #ffd700;
            border-radius: 5px;
            padding: 5px 10px;
            color: #ffd700;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .withdraw-button:hover {
            background: rgba(255, 215, 0, 0.3);
        }

        .telegram-payment {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 20px;
            width: 100%;
            text-align: center;
        }

        .telegram-payment h2 {
            margin-bottom: 15px;
            color: #ffd700;
        }

        .payment-button {
            background: linear-gradient(90deg, #0088cc, #34b7f1);
            border: none;
            border-radius: 50px;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            box-shadow: 0 5px 15px rgba(52, 183, 241, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .payment-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(52, 183, 241, 0.4);
        }

        .result-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .result-modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .result-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 300px;
            width: 90%;
            border: 2px solid #ffd700;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
        }

        .result-gift {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .result-text {
            font-size: 24px;
            margin-bottom: 20px;
            color: #ffd700;
        }

        .close-result {
            background: #ffd700;
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            font-weight: bold;
            color: #1a1a2e;
            cursor: pointer;
        }

        .empty-inventory {
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px;
            color: #aaa;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        @media (max-width: 500px) {
            .inventory-items {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Telegram Stars Roulette</h1>
            <div class="stars-balance">
                <span>‚≠ê</span>
                <span id="stars-count">0</span>
            </div>
        </div>

        <div class="roulette-container">
            <div class="roulette-wheel">
                <div class="roulette-items" id="roulette-items">
                    <!-- Roulette items will be generated by JavaScript -->
                </div>
            </div>
            <button class="spin-button" id="spin-button">–ö—Ä—É—Ç–∏—Ç—å –∑–∞ 25 ‚≠ê</button>
            <div class="cost-info">–ö–∞–∂–¥—ã–π —Å–ø–∏–Ω —Å—Ç–æ–∏—Ç 25 –∑–≤–µ–∑–¥</div>
        </div>

        <div class="inventory-section">
            <h2>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø–æ–¥–∞—Ä–∫–æ–≤</h2>
            <div class="inventory-items" id="inventory-items">
                <div class="empty-inventory">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–∞—Ä–∫–æ–≤</div>
            </div>
        </div>

        <div class="telegram-payment">
            <h2>–û–ø–ª–∞—Ç–∏—Ç—å –∑–≤–µ–∑–¥–∞–º–∏ Telegram</h2>
            <button class="payment-button" id="payment-button">
                <span>‚≠ê</span>
                –ö—É–ø–∏—Ç—å 25 –∑–≤–µ–∑–¥ –¥–ª—è —Å–ø–∏–Ω–∞
            </button>
        </div>
    </div>

    <div class="result-modal" id="result-modal">
        <div class="result-content">
            <div class="result-gift" id="result-gift">üéÅ</div>
            <div class="result-text" id="result-text">–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –ø–æ–¥–∞—Ä–æ–∫ –∑–∞ 15 ‚≠ê!</div>
            <button class="close-result" id="close-result">–ó–∞–±—Ä–∞—Ç—å</button>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.setText("–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é").show();

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const user = tg.initDataUnsafe?.user;
        const userId = user?.id || 'anonymous';

        // Initial state
        let stars = 0;
        let inventory = [];
        const gifts = [
            { value: 15, icon: "üéÅ", name: "–ü–æ–¥–∞—Ä–æ–∫ –∑–∞ 15 –∑–≤–µ–∑–¥" },
            { value: 25, icon: "üéâ", name: "–ü–æ–¥–∞—Ä–æ–∫ –∑–∞ 25 –∑–≤–µ–∑–¥" },
            { value: 50, icon: "üèÜ", name: "–ü–æ–¥–∞—Ä–æ–∫ –∑–∞ 50 –∑–≤–µ–∑–¥" },
            { value: 100, icon: "üíé", name: "–ü–æ–¥–∞—Ä–æ–∫ –∑–∞ 100 –∑–≤–µ–∑–¥" }
        ];

        // DOM elements
        const starsCountElement = document.getElementById('stars-count');
        const rouletteItemsElement = document.getElementById('roulette-items');
        const spinButton = document.getElementById('spin-button');
        const inventoryItemsElement = document.getElementById('inventory-items');
        const resultModal = document.getElementById('result-modal');
        const resultGift = document.getElementById('result-gift');
        const resultText = document.getElementById('result-text');
        const closeResult = document.getElementById('close-result');
        const paymentButton = document.getElementById('payment-button');

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
        function loadUserData() {
            try {
                const savedData = localStorage.getItem(`tg_roulette_${userId}`);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    stars = data.stars || 0;
                    inventory = data.inventory || [];
                }
            } catch (e) {
                console.error('Error loading user data:', e);
            }
            updateStarsDisplay();
            updateInventoryDisplay();
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
        function saveUserData() {
            try {
                const data = {
                    stars: stars,
                    inventory: inventory,
                    lastUpdate: new Date().toISOString()
                };
                localStorage.setItem(`tg_roulette_${userId}`, JSON.stringify(data));
            } catch (e) {
                console.error('Error saving user data:', e);
            }
        }

        // Initialize roulette items
        function initRoulette() {
            rouletteItemsElement.innerHTML = '';
            // Create multiple copies of gifts to make the roulette longer
            for (let i = 0; i < 10; i++) {
                gifts.forEach((gift, index) => {
                    const item = document.createElement('div');
                    item.className = 'roulette-item';
                    item.innerHTML = `
                        <div class="gift-icon">${gift.icon}</div>
                        <div class="gift-value">${gift.value} ‚≠ê</div>
                    `;
                    rouletteItemsElement.appendChild(item);
                });
            }
        }

        // Update stars display
        function updateStarsDisplay() {
            starsCountElement.textContent = stars;
            spinButton.disabled = stars < 25;
            spinButton.textContent = stars >= 25 ? '–ö—Ä—É—Ç–∏—Ç—å –∑–∞ 25 ‚≠ê' : '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤–µ–∑–¥';
        }

        // Update inventory display
        function updateInventoryDisplay() {
            if (inventory.length === 0) {
                inventoryItemsElement.innerHTML = '<div class="empty-inventory">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–∞—Ä–∫–æ–≤</div>';
                return;
            }

            inventoryItemsElement.innerHTML = '';
            inventory.forEach((item, index) => {
                const inventoryItem = document.createElement('div');
                inventoryItem.className = 'inventory-item';
                inventoryItem.innerHTML = `
                    <div class="gift-icon">${item.icon}</div>
                    <div>${item.name}</div>
                    <button class="withdraw-button" data-index="${index}">–í—ã–≤–µ—Å—Ç–∏</button>
                `;
                inventoryItemsElement.appendChild(inventoryItem);
            });

            // Add event listeners to withdraw buttons
            document.querySelectorAll('.withdraw-button').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    withdrawGift(index);
                });
            });
        }

        // Spin the roulette
        function spinRoulette() {
            if (stars < 25) return;

            // Deduct stars
            stars -= 25;
            updateStarsDisplay();
            saveUserData();

            // Disable spin button during animation
            spinButton.disabled = true;

            // Calculate position - always lands on 15 stars gift
            const targetGiftIndex = 0; // Index of 15 stars gift
            const itemWidth = 150;
            const itemsPerSet = gifts.length;
            const totalItems = itemsPerSet * 10; // 10 sets of gifts
            const targetPosition = (5 * itemsPerSet + targetGiftIndex) * itemWidth; // Land on 15 stars gift

            // Reset position to start animation from the beginning
            rouletteItemsElement.style.transition = 'none';
            rouletteItemsElement.style.transform = 'translateX(0)';

            // Force reflow
            void rouletteItemsElement.offsetWidth;

            // Animate the roulette
            rouletteItemsElement.style.transition = 'transform 3s cubic-bezier(0.2, 0.8, 0.3, 1)';
            rouletteItemsElement.style.transform = `translateX(-${targetPosition}px)`;

            // Show result after animation
            setTimeout(() => {
                // Add gift to inventory
                const wonGift = {...gifts[0]}; // Always the 15 stars gift
                inventory.push(wonGift);
                updateInventoryDisplay();
                saveUserData();

                // Show result modal
                resultGift.textContent = wonGift.icon;
                resultText.textContent = `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${wonGift.name}!`;
                resultModal.classList.add('active');
            }, 3000);
        }

        // Withdraw gift
        function withdrawGift(index) {
            if (index >= 0 && index < inventory.length) {
                const gift = inventory[index];

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≤—ã–≤–æ–¥–µ –≤ Telegram –±–æ—Ç
                if (tg && tg.sendData) {
                    const withdrawData = {
                        action: 'withdraw_gift',
                        gift: gift,
                        userId: userId
                    };
                    tg.sendData(JSON.stringify(withdrawData));
                }

                alert(`–ü–æ–¥–∞—Ä–æ–∫ "${gift.name}" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤—ã–≤–æ–¥!`);
                inventory.splice(index, 1);
                updateInventoryDisplay();
                saveUserData();
            }
        }

        // Real Telegram Stars payment
        function processTelegramPayment() {
            if (!tg) {
                alert('–û—à–∏–±–∫–∞: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω–æ –≤ Telegram');
                return;
            }

            paymentButton.classList.add('loading');
            paymentButton.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';

            // –°–æ–∑–¥–∞–µ–º –∏–Ω–≤–æ–π—Å –¥–ª—è –æ–ø–ª–∞—Ç—ã
            const invoice = {
                title: "–ü–æ–∫—É–ø–∫–∞ —Å–ø–∏–Ω–∞ –≤ —Ä—É–ª–µ—Ç–∫–µ",
                description: "25 –∑–≤–µ–∑–¥ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–∫—Ä—É—Ç–∞ —Ä—É–ª–µ—Ç–∫–∏",
                payload: `${userId}_spin_payment_${Date.now()}`,
                currency: "XTR", // Telegram Stars currency
                prices: [
                    {
                        label: "25 Stars",
                        amount: 25
                    }
                ]
            };

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–ª–∞—Ç–µ–∂–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Telegram
            tg.openInvoice(invoice, (status) => {
                paymentButton.classList.remove('loading');
                paymentButton.innerHTML = '<span>‚≠ê</span> –ö—É–ø–∏—Ç—å 25 –∑–≤–µ–∑–¥ –¥–ª—è —Å–ø–∏–Ω–∞';

                if (status === 'paid') {
                    // –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω
                    stars += 25;
                    updateStarsDisplay();
                    saveUserData();

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
                    if (tg.sendData) {
                        const paymentData = {
                            action: 'payment_success',
                            amount: 25,
                            userId: userId,
                            payload: invoice.payload
                        };
                        tg.sendData(JSON.stringify(paymentData));
                    }

                    tg.showPopup({
                        title: "–£—Å–ø–µ—à–Ω–æ!",
                        message: "25 –∑–≤–µ–∑–¥ –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞ –≤–∞—à —Å—á–µ—Ç!",
                        buttons: [{ type: "ok" }]
                    });
                } else if (status === 'failed') {
                    tg.showPopup({
                        title: "–û—à–∏–±–∫–∞",
                        message: "–ü–ª–∞—Ç–µ–∂ –Ω–µ –ø—Ä–æ—à–µ–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.",
                        buttons: [{ type: "ok" }]
                    });
                } else if (status === 'cancelled') {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –ø–ª–∞—Ç–µ–∂
                }
            });
        }

        // Event listeners
        spinButton.addEventListener('click', spinRoulette);

        closeResult.addEventListener('click', () => {
            resultModal.classList.remove('active');
            spinButton.disabled = stars < 25;
        });

        paymentButton.addEventListener('click', processTelegramPayment);

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç Telegram –±–æ—Ç–∞
        tg.onEvent('webAppDataReceived', (data) => {
            try {
                const receivedData = JSON.parse(data);
                if (receivedData.action === 'add_stars') {
                    stars += receivedData.amount;
                    updateStarsDisplay();
                    saveUserData();
                }
            } catch (e) {
                console.error('Error processing web app data:', e);
            }
        });

        // Initialize
        initRoulette();
        loadUserData();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        if (user) {
            console.log('User:', user);
        }
    </script>
</body>
</html>
